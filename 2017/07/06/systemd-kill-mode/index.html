<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Systemd Kill Mode | Ox333333</title><meta name="description" content="This blog gives a details explanation of how systemd kills a service."><meta name="keywords" content="Linux, Systemd, Process"><meta name="subtitle" content="In Pursuit of Absolute Simplicity"><meta name="author" content="Ox333333"><meta name="google-site-verification" content="cvPAyZ-ZCL95oXwVejN2W-cxTBfUemEGQOnHKDEQ8Dk"><meta name="msvalidate.01" content="31FA25C5697C3CA088656A9B63A9013F"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="og:site_name" content="Ox333333"><meta name="og:type" content="website"><meta name="og:title" content="Systemd Kill Mode"><meta name="og:descricption" content="This blog gives a details explanation of how systemd kills a service."><meta name="og:url" content="https://zpjiang.me/2017/07/06/systemd-kill-mode/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Systemd Kill Mode"><meta name="twitter:description" content="This blog gives a details explanation of how systemd kills a service."><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url" content="https://zpjiang.me/2017/07/06/systemd-kill-mode/"><link rel="canonical" href="https://zpjiang.me/2017/07/06/systemd-kill-mode/"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zpjiang.me/atom.xml" title="Ox333333"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://blog.1pixel.cc" target="_blank" class="nav-list-link">TRAVEL</a></li><li class="nav-list-item"><a href="https://1pixel.cc" target="_blank" class="nav-list-link">PHOTOGRAPHY</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Systemd Kill Mode</h1><div class="post-info">Jul 6, 2017</div><div class="post-content"><p>I used to create a shell script to start a service if I have to pass arguments to the binary, since it does not support command line arguments in the field <code>ExecStart</code> in service file.</p>
<p>I worked well except that when I tried to restart a web server with <code>systemctl restart XXX.service</code>, it failed to listen on the port as the port was being used by another process. That was wired because that port was used by the web server right before I restarted the service. I checked the port state by using <code>netstat -nalp</code>, found that it was actually being listened by the web server. I did run restart and I was pretty sure the service is down because its status is <code>inactive</code>.</p>
<span id="more"></span>
<p>Manually I killed the web server and started the service again, I found that by using <code>systemctl start</code> it created two process.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  xxx git:(master) ✗ ps f -g 57699</span><br><span class="line">  PID TTY      STAT   TIME COMMAND</span><br><span class="line">57699 ?        Ss     0:00 /bin/sh /root/bbbbb/start.sh</span><br><span class="line">57700 ?        Sl     4:37  \_ ./node_exporter -collectors.enabled diskstats,filefd,filesystem,meminfo,netdev,netstat,sockstat,tcpstat,logind -web.listen-address :9104 -web.telemetr</span><br></pre></td></tr></table></figure>
<p>The process <code>57699</code> was created by <code>systemctl</code> while the actual web server <code>57700</code> was launched by <code>57699</code>. If I run <code>systemctl stop</code> or <code>systemctl restart</code>, it simply kills the process <code>57699</code>, without checking the status of its child process.</p>
<p>I went back to Google and try to find out how to kill the child process as well, apparently systemd supports this by setting up <a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/systemd.kill.html#KillMode=">KillMode</a>.</p>
<blockquote>
<p>If set to <strong>control-group</strong>, all remaining processes in the control group of this unit will be killed on unit stop (for services: after the stop command is executed, as configured with ExecStop=).<br>If set to <strong>process</strong>, only the main process itself is killed.<br>If set to <strong>mixed</strong>, the SIGTERM signal (see below) is sent to the main process while the subsequent SIGKILL signal (see below) is sent to all remaining processes of the unit’s control group.<br>If set to <strong>none</strong>, no process is killed. In this case, only the stop command will be executed on unit stop, but no process be killed otherwise. Processes remaining alive after stop are left in their control group and the control group continues to exist after stop unless it is empty.</p>
</blockquote>
<blockquote>
<p>Defaults to <strong>control-group</strong>.</p>
</blockquote>
<p>Indeed, I had the <code>KillMode</code> set to <code>process</code>, which only kills the main process.</p>
<p><strong>Good to know!</strong></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/07/10/Push-based-monitoring-for-Prometheus/" class="prev">上一篇</a><a href="/2017/06/05/struggling/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhipeng';
var disqus_identifier = '2017/07/06/systemd-kill-mode/';
var disqus_title = 'Systemd Kill Mode';
var disqus_url = 'http://zpjiang.me/2017/07/06/systemd-kill-mode/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhipeng.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2021 | <a href="http://zpjiang.me">Ox333333</a> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/3.0/">| CC BY-NC-SA</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async data-ad-client="ca-pub-9383149074803575" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-47515905-1",'auto');ga('send','pageview');</script></body></html>