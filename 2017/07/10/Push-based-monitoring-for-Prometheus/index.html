<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Push Based Monitoring Service with Prometheus | Ox333333</title><meta name="description" content="This blog gives a new design for a push based monitoring system with Prometheus."><meta name="keywords" content="Golang, Prometheus, Monitoring, Azure, Microsoft, Linux, Azure CDN, Smart DNS, Smart CDN, Azure China"><meta name="subtitle" content="In Pursuit of Absolute Simplicity"><meta name="author" content="Ox333333"><meta name="google-site-verification" content="cvPAyZ-ZCL95oXwVejN2W-cxTBfUemEGQOnHKDEQ8Dk"><meta name="msvalidate.01" content="31FA25C5697C3CA088656A9B63A9013F"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="og:site_name" content="Ox333333"><meta name="og:type" content="website"><meta name="og:title" content="Push Based Monitoring Service with Prometheus"><meta name="og:descricption" content="This blog gives a new design for a push based monitoring system with Prometheus."><meta name="og:url"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Push Based Monitoring Service with Prometheus"><meta name="twitter:description" content="This blog gives a new design for a push based monitoring system with Prometheus."><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url"><link rel="canonical"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zpjiang.me/atom.xml" title="Ox333333"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://blog.1pixel.cc" target="_blank" class="nav-list-link">TRAVEL</a></li><li class="nav-list-item"><a href="https://1pixel.cc" target="_blank" class="nav-list-link">PHOTOGRAPHY</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Push Based Monitoring Service with Prometheus</h1><div class="post-info">Jul 10, 2017</div><div class="post-content"><p>Prometheus natively supports pull model, but there’s a long discussion for Prometheus between pull and push, e.g. <a target="_blank" rel="noopener" href="https://prometheus.io/blog/2016/07/23/pull-does-not-scale-or-does-it/">Pull doesn’t scale - or does it?</a>. In this post it gives detailed pros and cons. Considering that we prefer not to expose an extra HTTP endpoint for each worker node, we would like to take some walk around to implement a push based monitoring with <a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter">node_exporter</a>, <a target="_blank" rel="noopener" href="https://github.com/prometheus/pushgateway">pushgateway</a> and <a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus">prometheus</a>.</p>
<span id="more"></span>
<h2 id="Main-Structure"><a href="#Main-Structure" class="headerlink" title="Main Structure"></a>Main Structure</h2><p>We have multiple service nodes, each of them hosts multiple services, we use <a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter">node_exporter</a> to collect system metrics.</p>
<p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/Screen%20Shot%202017-07-11%20at%205.47.35%20PM.png" alt="img"></p>
<p>What is different here is we add a forwarder between node_exporter and pushgateway, which helps us to switch the direction of data pipeline. Basically, node_exporter still listens on a specific port to expose metrics, but it only accepts internal requests. It helps us to keep the node safe from external malicious visits. Forwarder gets the metrics and send it to pushgateway, prometheus scraps data from pushgateway, instead of node_exporter.</p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p><strong> I. node_exporter </strong></p>
<p>It does not make any sense if we launch node_exporter in a separate container, because it needs to be able to access the host status directly by scraping system info files, not the container status. So in order to make life easy, we create a <code>exporter.service</code> to manage its lifetime.</p>
<p>By default the port <code>9014</code> will be listened by node_exporter, we should setup the inbound rules of network security group and make sure that it can not be accessed from outside to keep the node safe.</p>
<p><strong> II. Forwarder </strong></p>
<p>Instead of pulling data from node_exporter, we create an internal cron task to pull the metrics constantly from node_exporter and send it to pushgateway passively. The script is simple enough with no more than two <code>curl</code> calls. Of course it would be better if we check the exporter status before local pulling, this helps to eliminate empty push actions.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Send metrics to pushgateway</span></span><br><span class="line">curl -s http://$EXPORTER_ADDR/$EXPORTER_METRIC | curl --data-binary @- http://$PGW_ADDR/metrics/job/$PGW_JOB/instance/$PGW_INSTANCE</span><br></pre></td></tr></table></figure>
<p>The cron task can be added as below. However, it is not recommended to do that because it has the risk of adding duplicated tasks. A better way of doing this is to create <code>PID</code> file and use it as a lock. More details can be found here, <a target="_blank" rel="noopener" href="http://bencane.com/2015/09/22/preventing-duplicate-cron-job-executions/">Preventing duplicate cron job executions</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;*/1 * * * * /root/exporter/cron.sh &gt; /dev/null&quot; | crontab</span><br></pre></td></tr></table></figure>
<p><strong> III. Pushgateway </strong></p>
<p>Launching pushgateway is easy, simply follow the official document here <a target="_blank" rel="noopener" href="https://github.com/prometheus/pushgateway/blob/master/README.md">README.md</a>. I’d suggest to run pushgateway in a separate container by drafting a local Dockerfile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is an official Dockerfile</span></span><br><span class="line">FROM        quay.io/prometheus/busybox:latest</span><br><span class="line">MAINTAINER  The Prometheus Authors &lt;prometheus-developers@googlegroups.com&gt;</span><br><span class="line"></span><br><span class="line">COPY pushgateway /bin/pushgateway</span><br><span class="line"></span><br><span class="line">EXPOSE     9091</span><br><span class="line">WORKDIR    /pushgateway</span><br><span class="line">ENTRYPOINT [ <span class="string">&quot;/bin/pushgateway&quot;</span> ]</span><br></pre></td></tr></table></figure>
<p>You can add more parameters by appending <code>CMD</code> commands after <code>ENTRYPOINT</code>. Details of its parameters can be found by using <code>-h</code> option.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pushgateway -h</span><br></pre></td></tr></table></figure>
<p><strong> IV. Prometheus </strong></p>
<p>I’d recommend to launch prometheus by using container. You can follow the documentation here to setup a prometheus container within 5 min, <a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/install/#using-docker">Install Prometheus using Docker</a>.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This post gives a brief instructions on how to setup a push based monitoring service with <code>node_exporter</code>, <code>pushgateway</code> and <code>prometheus</code>. The key of replacing pull with push is simply adding a cron task that pulls local metrics and send it to pushgateway. It helps to hide the port <code>9014</code> from outside and keep the system safe.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/08/09/Setup-Jenkins-for-Go-Projects/" class="prev">上一篇</a><a href="/2017/07/06/systemd-kill-mode/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhipeng';
var disqus_identifier = '2017/07/10/Push-based-monitoring-for-Prometheus/';
var disqus_title = 'Push Based Monitoring Service with Prometheus';
var disqus_url = 'http://zpjiang.me/2017/07/10/Push-based-monitoring-for-Prometheus/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhipeng.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2021 | <a href="http://zpjiang.me">Ox333333</a> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/3.0/">| CC BY-NC-SA</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async data-ad-client="ca-pub-9383149074803575" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-47515905-1",'auto');ga('send','pageview');</script></body></html>