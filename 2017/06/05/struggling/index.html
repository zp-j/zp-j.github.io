<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>思考 | Ox333333</title><meta name="description" content="思考 - Ox333333"><meta name="keywords"><meta name="subtitle" content="In Pursuit of Absolute Simplicity"><meta name="author" content="Ox333333"><meta name="google-site-verification" content="cvPAyZ-ZCL95oXwVejN2W-cxTBfUemEGQOnHKDEQ8Dk"><meta name="msvalidate.01" content="31FA25C5697C3CA088656A9B63A9013F"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="og:site_name" content="Ox333333"><meta name="og:type" content="website"><meta name="og:title" content="思考"><meta name="og:descricption"><meta name="og:url"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="思考"><meta name="twitter:description"><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url"><link rel="canonical"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zpjiang.me/atom.xml" title="Ox333333"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://blog.1pixel.cc" target="_blank" class="nav-list-link">TRAVEL</a></li><li class="nav-list-item"><a href="https://1pixel.cc" target="_blank" class="nav-list-link">PHOTOGRAPHY</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">思考</h1><div class="post-info">Jun 5, 2017</div><div class="post-content"><p>讲几则小事，都发生在最近。</p>
<span id="more"></span>
<p><br></p>
<h5 id="三十而立"><a href="#三十而立" class="headerlink" title="三十而立"></a>三十而立</h5><blockquote>
<p>吾十有五，而志于学。三十而立。四十而不惑。五十而知天命。六十而耳顺。七十而从心所欲，不逾矩。  《论语·为政》</p>
</blockquote>
<p>昨天一位相当要好的朋友生日，与这位朋友相识也是巧合，赶上了14年 O2O 创业的大潮，恰好国内前端 SPA 开发刚刚兴起，当时我负责整个前端团队的开发。我这位朋友放弃了丰厚的薪水和优越的生活条件，在复旦旁边租了一套两层的复式大伙儿就开始干。第一次创业的拼劲很足，尤其是看到自己做的产品在高校内很受欢迎，心中的满足感油然而生。好多次大家奋斗到凌晨，夜深人静的时候撸串也会聊聊生活，谈谈理想。那段时间很幸福，虽然很累。在整个团队中，我这位朋友应该是最年长的一位，也许是因为他以前在银行做投资，在工作中，他分析问题的条理很清楚，思路也很灵活，并且作为CEO他确实能够看得更为长远，这点我相当佩服。后来因为私人原因我又重新回到了法国工作，这个创业项目已经做的很不错了，还记得当时办公室有张中国地图，上面标注着我们的产品所铺及的区域，每次看到都会感到震撼。</p>
<p>也就在公司逐渐步入正轨的时候，内部出现了一些问题。人心不齐，而千里之堤溃于蚁穴，后来发生的事情以及资本的干涉让这家公司几乎在一两周内崩塌。我朋友经历了从无到有，又残酷地经历了从有到无。事后，很多人谈起这个创业项目，会摆出一堆的大道理，讲资本泡沫，风口，可我知道，事情绝非如此简单，人们会用言之凿凿的理由去臆断看到的现象，但除了亲身经历过，谁也没有办法感同身受，面对那样的局面需要有多大的勇气。</p>
<p>朋友经历他最痛苦的那几个月，后来尝试了不同的方向，现在做回他的老本行，在金融和医疗间寻找突破点。昨天party上听几个合伙人闲聊，月流水已过千万。他昨天 party 上说的最多的一句话，就是觉得他现在变得平静了。</p>
<p>是啊，经历了这么多，那些生活中的小困难又算得了什么呢。</p>
<p><br></p>
<h5 id="好的架构是迭代演进出来的"><a href="#好的架构是迭代演进出来的" class="headerlink" title="好的架构是迭代演进出来的"></a>好的架构是迭代演进出来的</h5><p>最近帮朋友做 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Internet_of_things">IoT</a> 的项目，涉及到很多高并发的场景，准确说是高并发与高可靠交错、需要双重保证的场景。比如说，对 IoT 设备心跳的处理肯定是利用高并发的架构去扛住巨大的流量，而对于每台设备上的支付请求则必须要用高可靠的方案去保证事物一致性。由于设备也处于早起摸索阶段，设备本身对于消息的处理机制也在不断的迭代，云端的解决方案也在不停的优化中。</p>
<p>最初，设备并没有直接上 <a target="_blank" rel="noopener" href="http://mqtt.org/">MQTT</a> 的解决方案，而是通过简单粗暴的单向 HTTP 轮询来实现消息通信。主要分为两类消息，心跳和支付，对于心跳请求我们直接利用消息队列来顶住并发，心跳请求并不在乎返回的响应，所以做成异步处理效果更好，扩展性也更强。对于支付请求，由于缺乏设备反控机制，设备的控制只能又支付请求的响应来判断，这样做实属无奈之举，好在Go的并发处理能力足够强，对于支付响应我们充分利用了 Redis ，将整个业务异步处理，每次支付轮训尽量靠只做一次Redis请求来完成验证。这样的架构在 1k 左右的 QPS 时运行的很好。</p>
<p>后来，偶然的情况发现，支付和心跳两个API分开发送请求对电量的消耗影响还是不容忽视的，所以硬件团队决定将两个 API 合并，减少发送的 Request 数量，虽然我心里觉得这样根本不解决问题，而且由于心跳和支付合并，导致这里不能再用消息队列作为心跳的缓冲了，只能硬着头皮改我的 Go 来顶住所有的流量。其实原理也很简单，借鉴 Nginx 的异步思想，我充分利用了 Channel 的伸缩性，在每个 Go 的 instance 上维护了一个自己的消息队列，然后异步消耗批量处理。不同的地方在于，controller 在接到 request 时需要对支付字段做一次校验，这里依然是依靠了 Redis 的强大性能。最终测试下来，4k 左右的 QPS 也能轻松撑住，大概两个 Medium Size 的 Go Instance。这里顺便吐槽下腾讯云跟阿里云的 Load balancer，腾讯云的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Round-robin_scheduling">Round Robin</a> 算法是伪轮询，一个 IP 永远只会被 hash 到固定的 instance 上，在 instance 数不变的前提下。而阿里云的 LB 是在第七层网络做的，腾讯云和 Azure 的 LB 都是在第四层做的，这样做的区别在于，腾讯云和 Azure LB 转发的 request 依然带着 client IP，而阿里的 LB 只会带 LB 的 IP，client IP 被藏在了 <code>x-forwarded-for</code> 里面。</p>
<p>系统稳定运行了一段时间后，团队也在不停地扩大， BD 的需求也越来越多，对于设备的历史状态的分析需求也越来越多，原本的 SQL 对高频且复杂的 Query 日显乏力，而 Redis 中仅保存了最新的设备状态。在此前提下，我开始引入 HBase 来管理如此大量的历史数据。在此之前也做了多方考量，考虑过几个主流的时间序数据库，以及 ElasticSearch 和 HBase，最终选择了 HBase，主要还是因为阿里和腾讯云都有现成的 HBase 服务，不需要自己搭建和维护，省去了很多成本，并在一定程度上保证了数据的可靠性（当然，这个决定也为后来的一些需求埋了坑）。在通读了 Google 的 Big Table 的最佳实践后，我开始着手开发历史数据的 Data Store。同样，在这个系统中，也引入了热数据和冷数据的不同模块来 handle 不同的业务需求，这里以后再谈，我们正在演进第四套架构，在此保证设备一切正常工作的基础上，期望能够handle更多更丰富的上层需求。</p>
<p><br></p>
<h5 id="各种面试"><a href="#各种面试" class="headerlink" title="各种面试"></a>各种面试</h5><p>继上个月实习生疯狂面试之后，现在做 phone screening 和 onsite 都感觉更加淡定，不会像以前那么局促害怕犯错，说太多怕引导太多干扰 candidate 思考，说太少怕交流太少没有办法 evaluate candidate 的真实水平。</p>
<p>前几天给一个22岁的小伙子做 phone screening，他拿过微软的 MVP，在 dotNet 社区非常活跃，Github 上面看到他在很多的 organization 里面。考虑到工程经验比较丰富，所以题目更偏数据结构，而不是tricky的算法。整体面下来两个感觉特别明显，一是太年轻，缺乏经验，不知道如何表达清楚，在谈简历的时候对很多项目的细节都没有说清楚，给我的回答无法切中要害。第二个是基础不够扎实，在这道数据结构的题目里面，由于对 <code>List.RemoveAt()</code> 这个函数的时间复杂度不了解，导致设计存在漏洞。我不能武断下结论说不知道这个时间复杂度就一定不行，但只要学过数据结构的人，把 RemoveAt 的实现稍微想一想应该就能得出答案了，这个不是死记硬背的知识。</p>
<p>除了这位小伙子，还面试了三四个工作五到十年的 dev，有两个是 interview + lunch，面试完之后再带过去吃饭，也没人告诉我吃饭的时候是不是还要继续考察，我基本就是跟 candidate 闲聊了。在这几个 candidate 里面，印象比较深的是有 A 和 B 两位，A 擅长 Java，人比较聪明，思维比较快，这点很不错。另外做的项目也不少，跟我们 team 做的内容也比较 match，对于高并发以及分布式也有过实战经验，这个我们还是比较看中的。另一位 candidate B，做了好多年的 dotNet 开发，对 C# 底层的实现很熟，这是个plus，在实际面试做题时，他能够非常职业地优先考虑线程安全、输入合法性、模版化等方面，这个很不错，而且在做完 implementation，他还会提出做对应的 Unit test 和 load test，这点是我之前面试的 candidate 中没有人提过的，big plus。</p>
<p>现在回头看看，面试了这么多轮，其实自己的收获也是非常多的，通过candidate，我能够更客观的看待自己的水平，取长补短。很感谢能在这么早起就能接触到不同的人，说不定这些面试技巧，以后也能帮自己一把呢。</p>
<p><br></p>
<h5 id="社交网络"><a href="#社交网络" class="headerlink" title="社交网络"></a>社交网络</h5><p>最近两周，一鼓作气把 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Black_Mirror">Black Mirror</a> 看完了，不停感叹编剧敏锐洞察力的同时，也不得不把自己生活的状态跟剧中的情节做比较。想到自己生活也就那样，难免看完一集都会郁闷好一会儿。网上对该剧的评论很多，这里就不长篇大论了。这里主要分享些网上别人没提到的。</p>
<p>编剧一定绝顶聪明才能观察如此细致，并能透过现实的表象看清其本质。不仅如此，编剧还能找到一个恰当的故事做载体，通过夸张的艺术手法将这本质呈现给观众。不论是像 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hated_in_the_Nation_(Black_Mirror">Hated in the Nation</a>) 还是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/White_Bear_(Black_Mirror">White Bear</a>)，其背后都涉及到了同一个问题，人性。互联网如此发达的今天，社交网络平台恰好给了人们自由表达的平台。就像人类简史里提到的那样，人类可以通过语言表达自己的观点，并借此收获一群簇拥自己观点的粉丝。回头想想，所谓的国家意志、阶级、宗教，这些人类所发明出来的以追求共同利益而抱团的现象，才是人类和动物最大的区别。</p>
<p><strong>TODO</strong>: Not finished yet, to be completed.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/07/06/systemd-kill-mode/" class="prev">上一篇</a><a href="/2017/04/19/Interview-Thoughts/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhipeng';
var disqus_identifier = '2017/06/05/struggling/';
var disqus_title = '思考';
var disqus_url = 'http://zpjiang.me/2017/06/05/struggling/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhipeng.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2021 | <a href="http://zpjiang.me">Ox333333</a> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/3.0/">| CC BY-NC-SA</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async data-ad-client="ca-pub-9383149074803575" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-47515905-1",'auto');ga('send','pageview');</script></body></html>