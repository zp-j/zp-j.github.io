<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Pay Attention to SQL Stored Procedure | Ox333333</title><meta name="description" content="This blog gives some key points in using MySQL Stored Procedure."><meta name="keywords" content="Azure, China, Azure SQL, MySQL, Stored procedure, Azure MySQL"><meta name="subtitle" content="In Pursuit of Absolute Simplicity"><meta name="author" content="Ox333333"><meta name="google-site-verification" content="cvPAyZ-ZCL95oXwVejN2W-cxTBfUemEGQOnHKDEQ8Dk"><meta name="msvalidate.01" content="31FA25C5697C3CA088656A9B63A9013F"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="og:site_name" content="Ox333333"><meta name="og:type" content="website"><meta name="og:title" content="Pay Attention to SQL Stored Procedure"><meta name="og:descricption" content="This blog gives some key points in using MySQL Stored Procedure."><meta name="og:url"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Pay Attention to SQL Stored Procedure"><meta name="twitter:description" content="This blog gives some key points in using MySQL Stored Procedure."><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url"><link rel="canonical"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zpjiang.me/atom.xml" title="Ox333333"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://blog.1pixel.cc" target="_blank" class="nav-list-link">TRAVEL</a></li><li class="nav-list-item"><a href="https://1pixel.cc" target="_blank" class="nav-list-link">PHOTOGRAPHY</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Pay Attention to SQL Stored Procedure</h1><div class="post-info">Nov 23, 2016</div><div class="post-content"><p>I have been through a tough period with <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-net/en/connector-net-tutorials-stored-procedures.html">MySQL stored procedure</a> and <a target="_blank" rel="noopener" href="https://github.com/aspnet/EntityFramework6">Entity Framework</a>. To tell the truth, it is really painful to work on Visual Studio with Entity Framework, especially for teamwork. Anyway, back to stored procedure, unlike other advanced programming languages, <strong>there are some functions that do not perform like what we expect</strong>.</p>
<span id="more"></span>
<h2 id="GROUP-CONCAT-has-a-default-max-length"><a href="#GROUP-CONCAT-has-a-default-max-length" class="headerlink" title="GROUP_CONCAT() has a default max length"></a>GROUP_CONCAT() has a default max length</h2><p><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/group-by-functions.html#function_group-concat">GROUP_CONCAT()</a> returns a concatenated string from a group of items, for example,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> student_name,</span><br><span class="line">GROUP_CONCAT(test_score)</span><br><span class="line"><span class="keyword">FROM</span> student</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> student_name;</span><br></pre></td></tr></table></figure>
<p><strong>The result is trucated to the maximum length that is set by the variable <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_group_concat_max_len">group_concat_max_len</a>, which has a default value of 1024</strong>.</p>
<p>Of course, you can reset the value, although the effective maximum length of the return value is constrained by the value of <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_max_allowed_packet">max_allowed_packet</a>. You can change the value at runtime as follows,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> [<span class="keyword">GLOBAL</span> <span class="operator">|</span> SESSION] group_concat_max_len <span class="operator">=</span> <span class="number">65535</span>;</span><br></pre></td></tr></table></figure>
<h2 id="CONCAT-returns-NULL-if-any-argument-is-NULL"><a href="#CONCAT-returns-NULL-if-any-argument-is-NULL" class="headerlink" title="CONCAT() returns NULL if any argument is NULL"></a>CONCAT() returns NULL if any argument is NULL</h2><p>I was quite surprised when I learned this, for other programming languages it does not make much sense to return NULL directly if any argument is NULL.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;My&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;QL&#x27;</span>);</span><br><span class="line"><span class="comment">--  -&gt; &#x27;MySQL&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;My&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;QL&#x27;</span>);</span><br><span class="line"><span class="comment">--  -&gt; NULL</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="number">14.3</span>);</span><br><span class="line"><span class="comment">--  -&gt; &#x27;14.3&#x27;</span></span><br></pre></td></tr></table></figure>
<p>An quick walk-around is wrap argument with <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#function_coalesce">COALESCE()</a>, which returns the first no-null argument.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COALESCE</span>(<span class="keyword">NULL</span>,<span class="number">1</span>);</span><br><span class="line"><span class="comment">--  -&gt; 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COALESCE</span>(<span class="keyword">NULL</span>,<span class="keyword">NULL</span>,<span class="keyword">NULL</span>);</span><br><span class="line"><span class="comment">--  -&gt; NULL</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;My&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="built_in">COALESCE</span>(<span class="keyword">NULL</span>, <span class="string">&#x27;QL&#x27;</span>));</span><br><span class="line"><span class="comment">--  -&gt; &#x27;MySQL&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Actually, there is another function <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/string-functions.html#function_concat-ws">CONCAT_WS()</a> that is better at handling NULL argument. <strong>CONCAT_WS()</strong> stands for Concatenate With Separator and is a special form of CONCAT(). The first argument is the separator for the rest of the arguments. The separator is added between the strings to be concatenated. The separator can be a string, as can the rest of the arguments. If the separator is NULL, the result is NULL.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONCAT_WS(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;First name&#x27;</span>,<span class="string">&#x27;Second name&#x27;</span>,<span class="string">&#x27;Last Name&#x27;</span>);</span><br><span class="line"><span class="comment">--  -&gt; &#x27;First name,Second name,Last Name&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT_WS(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;First name&#x27;</span>,<span class="keyword">NULL</span>,<span class="string">&#x27;Last Name&#x27;</span>);</span><br><span class="line"><span class="comment">--  -&gt; &#x27;First name,Last Name&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="65536-row-size-limits"><a href="#65536-row-size-limits" class="headerlink" title="65536 row size limits"></a>65536 row size limits</h2><p>According to <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/column-count-limit.html">MySQL 5.7 Reference Manual</a>,</p>
<blockquote>
<p>The internal representation of a MySQL table has a maximum row size limit of 65,535 bytes, even if the storage engine is capable of supporting larger rows</p>
</blockquote>
<p>So no matter how many VARCHARs in a row, the total size should not surpass the limit of row size.</p>
<blockquote>
<p>Values in VARCHAR columns are variable-length strings. The length can be specified as a value from 0 to 255 before MySQL 5.0.3, and 0 to 65,535 in 5.0.3 and later versions. The effective maximum length of a VARCHAR in MySQL 5.0.3 and later is subject to the maximum row size (65,535 bytes, which is shared among all columns) and the character set used.</p>
</blockquote>
<p>Use <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/blob.html">BLOB</a> or <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/blob.html">TEXT</a> if you have large amount of text, because they only contribute 9 to 12 bytes toward the row size, data is stored internally in a different area of memory than the row buffer.</p>
<h2 id="Use-SELECT-…-FGOR-UPDATE-to-lock-the-row"><a href="#Use-SELECT-…-FGOR-UPDATE-to-lock-the-row" class="headerlink" title="Use SELECT … FGOR UPDATE to lock the row"></a>Use SELECT … FGOR UPDATE to lock the row</h2><p>If you query data and then insert or update data <strong>with the same transaction</strong>, the regular SELECT can not give enough protection, other transactions can update or delete the same rows you just queried. Here InnoDB supports two types of locking reads that offer extra safety, <code>SELECT ... LOCK IN SHARE MODE</code> and <code>SELECT ... FOR UPDATE</code>. Here is an example for the latter.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> counter_field <span class="keyword">FROM</span> child_codes <span class="keyword">FOR</span> UPDATE;</span><br><span class="line">UPDATE child_codes <span class="keyword">SET</span> counter_field <span class="operator">=</span> counter_field <span class="operator">+</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>This is a good example for implementing an incremental counter, especially you have multiple readers and writers. Once a reader get the latest available data, it sets exclusive lock on the row it reads, other readers can no longer read the row unless update operation is done.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/26/Kubernetes-Installation/" class="prev">上一篇</a><a href="/2016/11/17/Merge-vs-Rebase/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhipeng';
var disqus_identifier = '2016/11/23/Pay-Attention-to-SQL-Stored-Procedure/';
var disqus_title = 'Pay Attention to SQL Stored Procedure';
var disqus_url = 'http://zpjiang.me/2016/11/23/Pay-Attention-to-SQL-Stored-Procedure/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhipeng.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2021 | <a href="http://zpjiang.me">Ox333333</a> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/3.0/">| CC BY-NC-SA</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async data-ad-client="ca-pub-9383149074803575" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-47515905-1",'auto');ga('send','pageview');</script></body></html>