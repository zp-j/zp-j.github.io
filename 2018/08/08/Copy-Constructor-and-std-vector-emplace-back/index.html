<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Copy constructor and emplace_back() in C++ | Ox333333</title><meta name="description" content="See how std::vector::emplace_back() eliminates unnecessary object copy operations, understand when/why/how/whether to use emplace_back instead of push_back."><meta name="keywords" content="Copy Constructor, vector, emplace_back, push_back, C++, C++11, 拷贝构造函数, 拷贝, 复制, 效率"><meta name="subtitle" content="In Pursuit of Absolute Simplicity"><meta name="author" content="Ox333333"><meta name="google-site-verification" content="cvPAyZ-ZCL95oXwVejN2W-cxTBfUemEGQOnHKDEQ8Dk"><meta name="msvalidate.01" content="31FA25C5697C3CA088656A9B63A9013F"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="og:site_name" content="Ox333333"><meta name="og:type" content="website"><meta name="og:title" content="Copy constructor and emplace_back() in C++"><meta name="og:descricption" content="See how std::vector::emplace_back() eliminates unnecessary object copy operations, understand when/why/how/whether to use emplace_back instead of push_back."><meta name="og:url" content="https://zpjiang.me/2018/08/08/Copy-Constructor-and-std-vector-emplace-back/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Copy constructor and emplace_back() in C++"><meta name="twitter:description" content="See how std::vector::emplace_back() eliminates unnecessary object copy operations, understand when/why/how/whether to use emplace_back instead of push_back."><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url" content="https://zpjiang.me/2018/08/08/Copy-Constructor-and-std-vector-emplace-back/"><link rel="canonical" href="https://zpjiang.me/2018/08/08/Copy-Constructor-and-std-vector-emplace-back/"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zpjiang.me/atom.xml" title="Ox333333"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://blog.1pixel.cc" target="_blank" class="nav-list-link">TRAVEL</a></li><li class="nav-list-item"><a href="https://1pixel.cc" target="_blank" class="nav-list-link">PHOTOGRAPHY</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Copy constructor and emplace_back() in C++</h1><div class="post-info">Aug 8, 2018</div><div class="post-content"><blockquote>
<p>A copy constructor of class T is a non-template constructor whose first parameter is <code>T&amp;‍</code>, <code>const T&amp;‍</code>, <code>volatile T&amp;‍</code>, or <code>const volatile T&amp;</code>‍, and either there are no other parameters, or the rest of the parameters all have default values.</p>
<p style="text-align: right;"><em>from</em> <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/copy_constructor">cppreference.com</a></p>
</blockquote>
<h2 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Typical declaration of a copy constructor.</span></span><br><span class="line"><span class="built_in">class_name</span> ( <span class="keyword">const</span> class_name &amp; )</span><br><span class="line"><span class="comment">// Forcing a copy constructor to be generated by the compiler.</span></span><br><span class="line"><span class="built_in">class_name</span> ( <span class="keyword">const</span> class_name &amp; ) = <span class="keyword">default</span>;</span><br><span class="line"><span class="comment">// Avoiding implicit generation of the copy constructor.</span></span><br><span class="line"><span class="built_in">class_name</span> ( <span class="keyword">const</span> class_name &amp; ) = <span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="When-is-copy-constructor-called"><a href="#When-is-copy-constructor-called" class="headerlink" title="When is copy constructor called?"></a>When is copy constructor called?</h2><p>In C++, a Copy Constructor may be called in following cases:</p>
<ul>
<li>When an object of the class is returned by value.</li>
<li>When an object of the class is passed (to a function) by value as an argument.</li>
<li>When an object is constructed based on another object of the same class.</li>
<li>When compiler generates a temporary object.</li>
</ul>
<p>Let’s talk about some cases where you might not even realize how many copies it has done. <strong>Copy is not cheap, sometimes</strong>. <em>In some cases, copy constructor can be avoided by <a href="https://zpjiang.me/2018/08/01/Copy-Elision-in-C/">Copy Elision</a>, but it is not in the scope of this discussion.</em></p>
<h2 id="Show-me-an-example"><a href="#Show-me-an-example" class="headerlink" title="Show me an example"></a>Show me an example</h2><p>How many times the copy constructor is called?</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::vector;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> x, y;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Point</span>() &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&gt;&gt; empty constructor called.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Point</span>(<span class="keyword">int</span> x1, <span class="keyword">int</span> y1) &#123;</span><br><span class="line">        x = x1; y = y1;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&gt;&gt; Normal constructor called.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy constructor</span></span><br><span class="line">    <span class="built_in">Point</span>(<span class="keyword">const</span> Point&amp; p2) &#123;</span><br><span class="line">        x = p2.x; y = p2.y;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&gt;&gt; Copy constructor called.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">2</span>;</span><br><span class="line">    std::vector&lt;Point&gt; points;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;=== &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; ===\n&quot;</span>;</span><br><span class="line">        points.<span class="built_in">push_back</span>(*(<span class="keyword">new</span> <span class="built_in">Point</span>(<span class="number">1</span>, <span class="number">2</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The answer is <strong><code>3</code></strong>.</p>
<ul>
<li>When <code>i</code> is <code>0</code>, it creates a new Point object, calls normal constructor.</li>
<li>Pushes it into vector, copy once.</li>
<li>When <code>i</code> is <code>1</code>, it creates a new Point object again, calls normal constructor.</li>
<li>Pushes again, copy again.</li>
<li>Wait, before push, vector <code>points</code> needs to resize (usually double the size), copy <code>points[0]</code> to new vector first, then push.</li>
<li>In total, <code>3</code> copy constructor calls and <code>2</code> normal calls.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">=== 0 ===</span><br><span class="line">&gt;&gt; Normal constructor called.</span><br><span class="line">&gt;&gt; Copy constructor called.  </span><br><span class="line">=== 1 ===</span><br><span class="line">&gt;&gt; Normal constructor called.</span><br><span class="line">&gt;&gt; Copy constructor called.</span><br><span class="line">&gt;&gt; Copy constructor called.</span><br></pre></td></tr></table></figure>
<p>You can run this code online, <a target="_blank" rel="noopener" href="https://onlinegdb.com/BkuZ6vFB7">https://onlinegdb.com/BkuZ6vFB7</a>. Play with it, change <code>n</code> to some other value to see if you can get the right number of copy constructor calls.</p>
<h2 id="Can-we-do-better"><a href="#Can-we-do-better" class="headerlink" title="Can we do better?"></a>Can we do better?</h2><p>Yes, we can use <code>std::vector::emplace_back()</code> instead of <code>std::vector::push_back()</code>.</p>
<blockquote>
<p>(It) Appends a new element to the end of the container. The element is constructed through <code>std::allocator_traits::construct</code>, which typically uses placement-new to construct the element in-place at the location provided by the container.</p>
<p style="text-align: right;"><em>from</em> <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/vector/emplace_back">cppreference.com</a></p>
</blockquote>
<p>Let’s change the <code>main()</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">2</span>;</span><br><span class="line">    std::vector&lt;Point&gt; points;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;=== &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; ===\n&quot;</span>;</span><br><span class="line">        points.<span class="built_in">emplace_back</span>(<span class="number">1</span>, <span class="number">2</span>);  <span class="comment">// &lt;- uses emplace_back.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>How many times does copy constructor get called? <strong>Only once</strong>.</p>
<ul>
<li>When <code>i</code> is <code>0</code>, <code>emplace_back</code> calls the normal constructor of <code>Point</code>, put the newly created object in vector directly. <strong>no copy</strong>.</li>
<li>When <code>i</code> is <code>1</code>, <code>points</code> resizes itself, need to copy the existing element <code>points[0]</code>, <strong>one copy</strong>.</li>
<li>Then, as the first step, <code>emplace_back</code> creates new object in place, <strong>no copy</strong> needed.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=== 0 ===</span><br><span class="line">&gt;&gt; Normal constructor called.</span><br><span class="line">=== 1 ===</span><br><span class="line">&gt;&gt; Normal constructor called.</span><br><span class="line">&gt;&gt; Copy constructor called.</span><br></pre></td></tr></table></figure>
<p>You can also run the code online, <a target="_blank" rel="noopener" href="https://onlinegdb.com/SJo_lOKSX">https://onlinegdb.com/SJo_lOKSX</a>. Change <code>n</code> to some other values to see if you can get the right number of copy constructor calls.</p>
<h2 id="Should-I-always-use-emplace-back"><a href="#Should-I-always-use-emplace-back" class="headerlink" title="Should I always use emplace_back()?"></a>Should I always use emplace_back()?</h2><p>We can not deny the fact that <code>std::vector::emplace_back()</code> saves unnecessary copy operations and it can be a big win for some operations on large objects. However, using <code>emplace_back</code> means you need to take care of the constructor arguments, which sometimes could be arbitrary. Check the example in <a target="_blank" rel="noopener" href="https://abseil.io/tips/112">Tip of the Week #112: emplace vs. push_back</a>, the second example constructs a vector of over a million elements, allocating several megabytes of memory in the process, if the variable type is not as what you think, and this is dangerous.</p>
<blockquote>
<p>For more expensive types, this may be a reason to use <code>emplace_back()</code> instead of <code>push_back()</code>, despite the readability and safety costs, but then again it may not. Very often the performance difference just won’t matter. As always, the rule of thumb is that you should avoid <em>optimizations</em> that make the code less safe or less clear, unless the performance benefit is big enough to show up in your application benchmarks.</p>
</blockquote>
<p>Let’s keep this in mind.</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/copy_constructor">Copy constructors</a></li>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/container/vector/emplace_back">std::vector::emplace_back</a></li>
<li><a target="_blank" rel="noopener" href="https://abseil.io/tips/112">Tip of the Week #112: emplace vs. push_back</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2018/09/16/use-string-view-to-avoid-copy-cpp17/" class="prev">上一篇</a><a href="/2018/08/01/Copy-Elision-in-C/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zhipeng';
var disqus_identifier = '2018/08/08/Copy-Constructor-and-std-vector-emplace-back/';
var disqus_title = 'Copy constructor and emplace_back() in C++';
var disqus_url = 'http://zpjiang.me/2018/08/08/Copy-Constructor-and-std-vector-emplace-back/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zhipeng.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2021 | <a href="http://zpjiang.me">Ox333333</a> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/3.0/">| CC BY-NC-SA</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async data-ad-client="ca-pub-9383149074803575" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-47515905-1",'auto');ga('send','pageview');</script></body></html>